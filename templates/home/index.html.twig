{% extends 'base.html.twig' %}

{% block title 'Liste des joueurs' %}
{% block page_header %}<h1 class="h3 fw-bold">Joueurs</h1>{% endblock %}
{% block body %}
<div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
        {# Bandeau debug visible uniquement en dev si besoin #}
            {# Bandeau debug retiré #}
        <form method="get" action="{{ path('app_home') }}" class="row g-3 align-items-end" id="players-filter-form" data-turbo="false">
            <input type="hidden" name="page" value="1">
            <div class="col-12 col-md-3">
                <label class="form-label small mb-1">Recherche</label>
                <input type="text" name="q" value="{{ criteria.q }}" class="form-control form-control-sm" placeholder="Nom..." autocomplete="off">
            </div>
            <div class="col-6 col-md-2">
                <label class="form-label small mb-1">Catégorie</label>
                <select name="category" class="form-select form-select-sm">
                    <option value="">Toutes</option>
                    {% for c in categories %}
                        <option value="{{ c.id }}" {% if criteria.category == c.id %}selected{% endif %}>{{ c.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-6 col-md-2">
                <label class="form-label small mb-1">Niveau</label>
                <select name="level" class="form-select form-select-sm">
                    <option value="">Tous</option>
                    {% for l in levels %}
                        <option value="{{ l.id }}" {% if criteria.level == l.id %}selected{% endif %}>{{ l.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-6 col-md-2">
                <label class="form-label small mb-1">Moy. min</label>
                <input type="number" step="0.1" min="0" max="5" name="minAvg" value="{{ criteria.minAvg }}" class="form-control form-control-sm" placeholder="Ex: 3">
            </div>
            <div class="col-6 col-md-3 d-flex gap-2">
                <button type="submit" class="btn btn-primary btn-sm flex-grow-1">Filtrer</button>
                <a href="{{ path('app_home') }}" class="btn btn-outline-secondary btn-sm">Réinitialiser</a>
            </div>
        </form>
        <script>
            (function(){
                const f = document.getElementById('players-filter-form');
                if(!f) return;
                const autos = f.querySelectorAll('select');
                autos.forEach(el=> el.addEventListener('change', ()=> { f.querySelector('input[name="page"]').value='1'; f.submit(); }));
            })();
        </script>
    </div>
</div>

<div class="row g-4">
        {% for player in players %}
                {% set avg = averages[player.id] ?? 0 %}
                <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                        <div class="card h-100 shadow-sm border-0 player-card">
                                <div class="ratio ratio-16x9 bg-light d-flex align-items-center justify-content-center text-muted small">Photo</div>
                                <div class="card-body d-flex flex-column">
                                        <h5 class="card-title mb-1">{{ player.firstName }} {{ player.lastName }}</h5>
                                        <p class="text-secondary small mb-2">{{ player.category.name }} • {{ player.level.name }}</p>
                                        <div class="mt-auto d-flex justify-content-between align-items-center">
                                                <span class="badge bg-primary">{{ avg|number_format(2, '.', ' ') }}</span>
                                                <a class="btn btn-sm btn-outline-primary" href="{{ path('app_player_show', {id: player.id}) }}">Voir</a>
                                        </div>
                                </div>
                        </div>
                </div>
        {% else %}
                <div class="col"><div class="alert alert-warning">Aucun joueur.</div></div>
        {% endfor %}
</div>

<div class="mt-4 d-flex justify-content-center">
    {% if pages > 1 %}
        <nav aria-label="Pagination joueurs">
            <ul class="pagination pagination-sm mb-0">
                {% set baseParams = {
                    'q': criteria.q,
                    'category': criteria.category,
                    'level': criteria.level,
                    'minAvg': criteria.minAvg
                } %}
                {% set sanitized = {} %}
                {% for k,v in baseParams %}
                    {% if v is not null and v is not same as('') %}
                        {% set sanitized = sanitized|merge({ (k): v }) %}
                    {% endif %}
                {% endfor %}
                {% set prev = page - 1 %}
                {% set next = page + 1 %}
                <li class="page-item {% if page == 1 %}disabled{% endif %}"><a class="page-link" href="{{ path('app_home', sanitized|merge({'page':1})) }}">«</a></li>
                <li class="page-item {% if page == 1 %}disabled{% endif %}"><a class="page-link" href="{{ path('app_home', sanitized|merge({'page':prev})) }}">‹</a></li>
                {% for p in 1..pages %}
                    {% if pages <= 8 or p in [1,2,pages-1,pages] or (p >= page-1 and p <= page+1) %}
                        <li class="page-item {% if p == page %}active{% endif %}"><a class="page-link" href="{{ path('app_home', sanitized|merge({'page':p})) }}">{{ p }}</a></li>
                    {% elseif p == 3 and page > 4 %}
                        <li class="page-item disabled"><span class="page-link">…</span></li>
                    {% elseif p == pages-2 and page < pages-3 %}
                        <li class="page-item disabled"><span class="page-link">…</span></li>
                    {% endif %}
                {% endfor %}
                <li class="page-item {% if page == pages %}disabled{% endif %}"><a class="page-link" href="{{ path('app_home', sanitized|merge({'page':next})) }}">›</a></li>
                <li class="page-item {% if page == pages %}disabled{% endif %}"><a class="page-link" href="{{ path('app_home', sanitized|merge({'page':pages})) }}">»</a></li>
            </ul>
        </nav>
    {% endif %}
</div>
<div class="text-center mt-2 small text-muted">Résultats: {{ total }} | Page {{ page }}/{{ pages }}{% if criteria.q or criteria.category or criteria.level or criteria.minAvg %} (filtres actifs){% endif %}</div>
{% endblock %}
